- hosts: webservers
  become: true
  tasks:
    - name: ‚úèÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–π Docker –∏ Docker Compose
      shell: |
        docker --version
        docker-compose --version
      register: docker_version_info

    - name: ‚úèÔ∏è –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–µ—Ä—Å–∏—è—Ö Docker
      debug:
        var: docker_version_info.stdout_lines

    - name: –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è deploy
      user:
        name: deploy
        shell: /bin/bash
        create_home: yes
        system: yes
  
    - name: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
      file:
        path: /home/deploy/my-app
        state: directory
        owner: deploy
        group: deploy
        mode: 0755

    - name: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ docker-compose.yml
      copy:
        src: ../docker-compose.yml
        dest: /home/deploy/my-app/docker-compose.yml
        owner: deploy
        group: deploy
        mode: 0644
 
    - name: ‚úèÔ∏è Debug domain
      debug:
        msg: "Domain is: {{ ansible_domain }}"
        
    - name: –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
      copy:
        content: |
          DB_NAME=wordpress
          DB_USER=root
          DB_PASSWORD=my-secret-pw
          DB_HOST=mariadb
          HOST_DOMAIN=217a114a11a97.zapto.org
          
        dest: /home/deploy/my-app/.env
        owner: deploy
        group: deploy
        mode: 0644

    - name: –û—á–∏—Å—Ç–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ –æ–±—Ä–∞–∑—ã Docker
      shell: docker system prune -af

    - name: üíø –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ tar-–∞—Ä—Ö–∏–≤–æ–≤ Docker-–æ–±—Ä–∞–∑–æ–≤
      copy:
        src: ../{{ item }}
        dest: /home/deploy/my-app/{{ item }}
        owner: deploy
        group: deploy
        mode: 0644
      loop:
        - mariadb.tar
        - nginx.tar
        - wordpress.tar

    - name: üê≥ –ó–∞–≥—Ä—É–∑–∫–∞ Docker-–æ–±—Ä–∞–∑–æ–≤
      command: docker load -i /home/deploy/my-app/{{ item }}
      args:
        chdir: /home/deploy/my-app
      loop:
        - mariadb.tar
        - nginx.tar
        - wordpress.tar
      ignore_errors: true # –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –æ–±—Ä–∞–∑—ã —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã

    - name: –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ —Ç–æ–º–∞ docker-compose
      shell: docker-compose down
      args:
        chdir: /home/deploy/my-app

    # try --force-recreate
    - name: üê≥ Deploy
      block:
        - name: Deploy services
          command: docker-compose up -d
          args:
            chdir: /home/deploy/my-app
