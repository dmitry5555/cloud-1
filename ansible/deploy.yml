- hosts: webservers
  become: true
  tasks:
    - name: –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è deploy
      user:
        name: deploy
        shell: /bin/bash
        create_home: yes
        system: yes
  
    - name: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
      file:
        path: /home/deploy/my-app
        state: directory
        owner: deploy
        group: deploy
        mode: 0755

    - name: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ docker-compose.yml
      copy:
        src: ../docker-compose.yml
        dest: /home/deploy/my-app/docker-compose.yml
        owner: deploy
        group: deploy
        mode: 0644
 
    - name: –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
      copy:
        content: |
          DB_NAME=wordpress
          DB_USER=root
          DB_PASSWORD=my-secret-pw
          DB_HOST=mariadb
          HOST_DOMAIN=217-1141197.hopto.org
        dest: /home/deploy/my-app/.env
        owner: deploy
        group: deploy
        mode: 0644

    - name: –û—á–∏—Å—Ç–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã Docker
      shell: docker system prune -af

    - name: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ tar-–∞—Ä—Ö–∏–≤–æ–≤ Docker-–æ–±—Ä–∞–∑–æ–≤
      copy:
        src: ../{{ item }}
        dest: /home/deploy/my-app/{{ item }}
        owner: deploy
        group: deploy
        mode: 0644
      loop:
        - mariadb.tar
        - nginx.tar


    - name: üíø –ó–∞–≥—Ä—É–∑–∫–∞ Docker-–æ–±—Ä–∞–∑–æ–≤
      command: docker load -i /home/deploy/my-app/{{ item }}
      args:
        chdir: /home/deploy/my-app
      loop:
        - mariadb.tar
        - nginx.tar
      ignore_errors: true # –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –æ–±—Ä–∞–∑—ã —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã

    # - name: –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ —Ç–æ–º–∞ docker-compose
    #   shell: docker-compose down -v
    #   args:
    #     chdir: /home/deploy/my-app
      
    - name: Deploy with rollback on failure
      block:
        - name: ‚úÖ Deploy services
          command: docker-compose up -d
          args:
            chdir: /home/deploy/my-app
      rescue:
        - name: üõº Rollback on failure
          command: docker-compose -f backup.yml up -d
          args:
            chdir: /home/deploy/my-app
